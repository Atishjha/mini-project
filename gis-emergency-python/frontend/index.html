<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Response System</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üö®</text></svg>">
    
    <!-- ‚úÖ Leaflet CSS & JS loaded FIRST in head ‚Äî fixes "L is not defined" error -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; padding-top: 60px; background-color: #f4f4f4; }
        
        .navbar { background: linear-gradient(135deg, #1e3c72, #2a5298); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1100; }
        
        .sidebar { position: fixed; left: 0; top: 60px; bottom: 0; width: 300px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-right: 1px solid #dee2e6; z-index: 1000; }
        
        .map-container { margin-left: 300px; padding: 15px; height: calc(100vh - 90px); }
        
        #map { height: 100%; width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1; }
        
        .modal { pointer-events: none; }
        .modal-dialog { pointer-events: auto; }
        
        /* ===== STAT CARDS ===== */
        .stat-card { padding: 15px; border-radius: 8px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 24px; margin-bottom: 10px; }
        .stat-card h3 { font-size: 28px; font-weight: bold; margin: 5px 0; }
        
        /* ===== INCIDENT MARKERS ===== */
        .emergency-marker { border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .emergency-marker.critical { background: #ff0000; width: 40px; height: 40px; font-size: 16px; animation: pulse 2s infinite; }
        .emergency-marker.high     { background: #ff6600; width: 35px; height: 35px; font-size: 14px; animation: pulse 2s infinite; }
        .emergency-marker.medium   { background: #ffcc00; width: 30px; height: 30px; font-size: 12px; color: #000; }
        .emergency-marker.low      { background: #00cc00; width: 25px; height: 25px; font-size: 11px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); } }

        /* ===== CROWD MARKERS ===== */
        .crowd-marker { border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid rgba(255,255,255,0.85); box-shadow: 0 2px 10px rgba(0,0,0,0.35); position: relative; }
        .crowd-marker.crowd-critical { background: radial-gradient(circle at 35% 35%, #ff4444, #8b0000); animation: crowdPulse 1.5s infinite; }
        .crowd-marker.crowd-high     { background: radial-gradient(circle at 35% 35%, #ff8800, #cc5500); animation: crowdPulse 2s infinite; }
        .crowd-marker.crowd-moderate { background: radial-gradient(circle at 35% 35%, #ffcc00, #cc9900); color: #333; }
        .crowd-marker.crowd-low      { background: radial-gradient(circle at 35% 35%, #44cc44, #228822); }
        .crowd-marker .crowd-warning { position: absolute; top: -6px; right: -6px; background: #ff0000; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 9px; border: 1.5px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.4); }
        @keyframes crowdPulse { 0% { box-shadow: 0 0 0 0 rgba(255,100,0,0.7); } 70% { box-shadow: 0 0 0 12px rgba(255,100,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,100,0,0); } }

        /* ===== CROWD SIDEBAR ITEMS ===== */
        .crowd-item { padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 4px solid; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .crowd-item:hover { transform: translateX(5px); }
        .crowd-item.crowd-critical { border-left-color: #8b0000; }
        .crowd-item.crowd-high     { border-left-color: #ff6600; }
        .crowd-item.crowd-moderate { border-left-color: #ccaa00; }
        .crowd-item.crowd-low      { border-left-color: #228822; }
        .crowd-density-pill { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-left: 4px; }
        .pill-critical { background: #ffe0e0; color: #8b0000; }
        .pill-high     { background: #ffe5cc; color: #cc5500; }
        .pill-moderate { background: #fff9cc; color: #8b6a00; }
        .pill-low      { background: #e0f7e0; color: #1a5c1a; }

        /* ===== RESOURCE ICONS ===== */
        .resource-icon { font-size: 24px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .resource-icon.ambulance { color: #dc3545; }
        .resource-icon.fire      { color: #ffc107; }
        .resource-icon.police    { color: #28a745; }

        /* ===== LEGEND ===== */
        .legend { position: absolute; bottom: 30px; right: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); min-width: 210px; max-height: calc(100vh - 130px); overflow-y: auto; }
        .legend-item { display: flex; align-items: center; margin: 8px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .legend-color.critical { background: #ff0000; }
        .legend-color.high     { background: #ff6600; }
        .legend-color.medium   { background: #ffcc00; }
        .legend-color.low      { background: #00cc00; }
        .legend-crowd-dot { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        /* ===== INCIDENT SIDEBAR ITEMS ===== */
        .incident-item { padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 4px solid; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .incident-item:hover { transform: translateX(5px); }
        .incident-item.critical { border-left-color: #ff0000; }
        .incident-item.high     { border-left-color: #ff6600; }
        .incident-item.medium   { border-left-color: #ffcc00; }
        .incident-item.low      { border-left-color: #00cc00; }

        /* ===== TOASTS ===== */
        .toast-container { position: fixed; top: 70px; right: 20px; z-index: 9999; }
        .toast { min-width: 300px; margin-bottom: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ===== LOCATION TABS ===== */
        .location-method-tabs { display: flex; gap: 4px; margin-bottom: 12px; background: #f1f3f5; padding: 4px; border-radius: 10px; }
        .loc-tab-btn { flex: 1; padding: 8px 10px; border: none; border-radius: 8px; background: transparent; font-size: 12px; font-weight: 600; color: #6c757d; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .loc-tab-btn.active { background: white; color: #1e3c72; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
        .loc-tab-btn:hover:not(.active) { background: rgba(255,255,255,0.6); color: #1e3c72; }
        .location-panel { display: none; }
        .location-panel.active { display: block; }

        /* ===== ADDRESS SEARCH ===== */
        .address-search-wrapper { position: relative; }
        .address-search-input { width: 100%; padding: 10px 42px 10px 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
        .address-search-input:focus { border-color: #2a5298; box-shadow: 0 0 0 3px rgba(42,82,152,0.12); }
        .address-search-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: #2a5298; border: none; border-radius: 6px; width: 30px; height: 30px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: background 0.2s; }
        .address-search-btn:hover { background: #1e3c72; }
        .address-suggestions { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: white; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 9999; max-height: 240px; overflow-y: auto; display: none; }
        .address-suggestions.visible { display: block; }
        .suggestion-item { padding: 10px 14px; cursor: pointer; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid #f1f3f5; transition: background 0.15s; font-size: 13px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: #f8f9fa; }
        .suggestion-item i { color: #dc3545; margin-top: 2px; flex-shrink: 0; font-size: 14px; }
        .suggestion-item .sug-main { font-weight: 600; color: #212529; line-height: 1.3; }
        .suggestion-item .sug-sub  { color: #6c757d; font-size: 11px; margin-top: 2px; }
        .suggestion-no-results { padding: 14px; text-align: center; color: #6c757d; font-size: 13px; }

        /* ===== SELECTED LOCATION CARD ===== */
        .selected-location-card { background: linear-gradient(135deg, #e8f5e9, #f1f8e9); border: 1px solid #a5d6a7; border-radius: 8px; padding: 10px 14px; margin-top: 10px; display: none; align-items: flex-start; gap: 10px; }
        .selected-location-card.visible { display: flex; }
        .selected-location-card i { color: #2e7d32; margin-top: 2px; flex-shrink: 0; }
        .selected-location-card .loc-name   { font-size: 13px; font-weight: 600; color: #1b5e20; }
        .selected-location-card .loc-coords { font-size: 11px; color: #388e3c; margin-top: 2px; }
        .loc-clear-btn { margin-left: auto; background: none; border: none; color: #888; cursor: pointer; font-size: 16px; padding: 0 2px; flex-shrink: 0; }
        .loc-clear-btn:hover { color: #dc3545; }

        /* ===== GPS BUTTON ===== */
        .gps-panel-btn { width: 100%; padding: 12px; border: 2px dashed #2a5298; background: transparent; border-radius: 8px; color: #2a5298; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .gps-panel-btn:hover { background: #e8eef8; }
        .gps-panel-btn.loading { opacity: 0.7; pointer-events: none; }

        /* ===== MY LOCATION BUTTON ===== */
        .current-location-btn { position: absolute; bottom: 100px; right: 10px; z-index: 1000; background: white; border: none; border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #007bff; transition: all 0.3s; }
        .current-location-btn:hover { background: #007bff; color: white; transform: scale(1.1); }

        /* ===== MINI MAP ===== */
        .mini-map-wrapper { border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa; transition: border-color 0.2s, box-shadow 0.2s; }
        .mini-map-wrapper:hover { border-color: #2a5298; box-shadow: 0 0 0 3px rgba(42,82,152,0.1); }
        .mini-map-wrapper.has-pin { border-color: #28a745; box-shadow: 0 0 0 3px rgba(40,167,69,0.12); }
        .mini-map-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; font-size: 12px; font-weight: 600; }
        .mini-map-header i { font-size: 13px; flex-shrink: 0; }
        .mini-map-header span { flex: 1; }
        .mini-map-reset-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; border-radius: 5px; padding: 3px 8px; font-size: 11px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 4px; }
        .mini-map-reset-btn:hover { background: rgba(255,255,255,0.35); }
        .mini-map-canvas { height: 260px; width: 100%; cursor: crosshair !important; position: relative; }
        .mini-map-canvas .leaflet-container { cursor: crosshair !important; }
        .mini-map-canvas .leaflet-grab { cursor: crosshair !important; }
        .mini-map-canvas .leaflet-dragging .leaflet-grab { cursor: grabbing !important; }
        .mini-map-footer { display: flex; align-items: center; gap: 8px; padding: 7px 12px; background: #f1f3f5; font-size: 12px; border-top: 1px solid #dee2e6; min-height: 34px; }
        .mini-map-footer.pinned { background: #d4edda; border-top-color: #c3e6cb; }
        .mini-map-footer.pinned i    { color: #28a745 !important; }
        .mini-map-footer.pinned span { color: #155724 !important; font-weight: 600; }
        .mini-pin-marker { display: flex; flex-direction: column; align-items: center; animation: pinDrop 0.35s cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes pinDrop { 0% { transform: translateY(-30px) scale(0.6); opacity: 0; } 60% { transform: translateY(4px) scale(1.1); opacity: 1; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
        .mini-pin-head   { width: 22px; height: 22px; background: #dc3545; border: 3px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 2px 8px rgba(220,53,69,0.5); }
        .mini-pin-shadow { width: 10px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%; margin-top: 1px; }

        /* ===== MEDIA / EVIDENCE ===== */
        .badge-unverified, .badge-verified { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.4px; vertical-align: middle; }
        .badge-unverified { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .badge-verified   { background: #d1f0da; color: #145a32; border: 1px solid #28a745; }
        .media-upload-zone { border: 2px dashed #ced4da; border-radius: 10px; padding: 20px 16px 14px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s, box-shadow 0.2s; background: #fafbfc; position: relative; }
        .media-upload-zone:hover, .media-upload-zone.dragover { border-color: #2a5298; background: #eef2fb; box-shadow: 0 0 0 3px rgba(42,82,152,0.1); }
        .media-upload-zone.has-files { border-style: solid; border-color: #28a745; background: #f6fef8; }
        .media-upload-icon { font-size: 36px; color: #adb5bd; margin-bottom: 8px; display: block; transition: color 0.2s, transform 0.2s; }
        .media-upload-zone:hover .media-upload-icon { color: #2a5298; transform: translateY(-3px); }
        .media-upload-title { font-weight: 700; font-size: 14px; color: #495057; margin-bottom: 3px; }
        .media-upload-sub   { font-size: 11px; color: #adb5bd; margin-bottom: 14px; }
        .media-btn-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .media-action-btn { padding: 7px 14px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .photo-btn { background: #e3f2fd; color: #1565c0; } .photo-btn:hover { background: #1565c0; color: white; transform: translateY(-1px); }
        .video-btn { background: #fce4ec; color: #b71c1c; } .video-btn:hover { background: #b71c1c; color: white; transform: translateY(-1px); }
        .file-btn  { background: #f3e5f5; color: #6a1b9a; } .file-btn:hover  { background: #6a1b9a; color: white; transform: translateY(-1px); }
        .media-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; margin-top: 10px; }
        .preview-thumb { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; background: #e9ecef; box-shadow: 0 1px 4px rgba(0,0,0,0.12); animation: thumbIn 0.25s ease; }
        @keyframes thumbIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .preview-thumb img, .preview-thumb video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .preview-thumb .thumb-remove { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(0,0,0,0.65); border: none; border-radius: 50%; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.15s; }
        .preview-thumb:hover .thumb-remove { opacity: 1; }
        .preview-thumb .thumb-type-badge { position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.55); color: white; font-size: 9px; padding: 1px 5px; border-radius: 4px; font-weight: 700; }
        .verification-bar { display: flex; align-items: center; gap: 12px; margin-top: 12px; padding: 10px 14px; border-radius: 8px; background: #fff8e1; border: 1px solid #ffe082; transition: background 0.4s, border-color 0.4s; }
        .verification-bar.verified { background: #e8f5e9; border-color: #a5d6a7; }
        .vbar-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; transition: background 0.4s, color 0.4s; }
        .vbar-icon.unverified { background: #ffe082; color: #f57f17; }
        .vbar-icon.verified   { background: #a5d6a7; color: #1b5e20; }
        .vbar-text { flex: 1; }
        .vbar-title { font-size: 13px; font-weight: 600; color: #333; }
        .vbar-sub   { font-size: 11px; color: #777; margin-top: 1px; }
        .vbar-count { font-size: 12px; font-weight: 700; color: #888; white-space: nowrap; }
        .verification-bar.verified .vbar-count { color: #2e7d32; }
        .footer-badge-verified   { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .footer-badge-unverified { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; background: #fff3cd; color: #856404; border: 1px solid #ffc107; border-radius: 20px; font-size: 12px; font-weight: 700; }

        /* ===== CAMERA OVERLAY ===== */
        .camera-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .camera-box { background: #111; border-radius: 16px; overflow: hidden; width: 100%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        .camera-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #1a1a1a; color: white; font-weight: 600; font-size: 14px; }
        .camera-close-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .camera-close-btn:hover { background: #dc3545; }
        .camera-preview { width: 100%; max-height: 320px; object-fit: cover; background: #000; display: block; }
        .camera-controls { display: flex; align-items: center; justify-content: center; gap: 24px; padding: 20px; background: #111; }
        .cam-ctrl-btn { background: none; border: none; cursor: pointer; transition: transform 0.15s; }
        .cam-ctrl-btn:hover { transform: scale(1.1); }
        .cam-flip, .cam-cancel { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.12); color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .cam-flip:hover   { background: rgba(255,255,255,0.25); }
        .cam-cancel:hover { background: #dc3545; }
        .cam-capture { width: 68px; height: 68px; border-radius: 50%; background: white; position: relative; display: flex; align-items: center; justify-content: center; }
        .cam-capture:hover { background: #f0f0f0; transform: scale(1.05); }
        .cam-capture.recording { background: #dc3545; }
        .cam-capture-ring { display: block; width: 54px; height: 54px; border-radius: 50%; border: 3px solid #333; }
        .cam-capture.recording .cam-capture-ring { border-radius: 6px; background: white; width: 22px; height: 22px; border: none; }
        .camera-hint { text-align: center; color: #aaa; font-size: 12px; padding-bottom: 14px; }
        @keyframes recPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .rec-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #dc3545; margin-right: 5px; animation: recPulse 1s infinite; }

        @media (max-width: 768px) {
            .sidebar { position: relative; width: 100%; top: 0; }
            .map-container { margin-left: 0; }
            #map { height: 50vh; }
            .mini-map-canvas { height: 200px; }
            .media-btn-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar navbar-dark fixed-top">
    <div class="container-fluid">
        <span class="navbar-brand">
            <i class="fas fa-ambulance text-danger me-2"></i>
            Emergency Response System
        </span>
        <div>
            <span class="text-white me-3"><i class="fas fa-circle text-success"></i> Live</span>
            <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
</nav>

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">
    <h5 class="mb-3"><i class="fas fa-dashboard"></i> Dashboard</h5>

    <div class="row g-2 mb-3">
        <div class="col-6">
            <div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#c82333)">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="active-incidents">0</h3>
                <small>Active Incidents</small>
            </div>
        </div>
        <div class="col-6">
            <div class="stat-card" style="background:linear-gradient(135deg,#28a745,#218838)">
                <i class="fas fa-truck"></i>
                <h3 id="available-resources">0</h3>
                <small>Resources</small>
            </div>
        </div>
        <div class="col-12">
            <div class="stat-card" style="background:linear-gradient(135deg,#7b2d8b,#9c27b0)">
                <i class="fas fa-people-group"></i>
                <h3 id="active-crowd-count">0</h3>
                <small>Crowd Detections</small>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <h6><i class="fas fa-filter"></i> Filters</h6>
        <select class="form-select mb-2" id="type-filter">
            <option value="all">All Types</option>
            <option value="fire">Fire</option>
            <option value="medical">Medical</option>
            <option value="accident">Accident</option>
            <option value="flood">Flood</option>
            <option value="earthquake">Earthquake</option>
        </select>
        <label class="form-label">Min Severity: <span id="severity-val">3</span></label>
        <input type="range" class="form-range" min="1" max="5" value="3" id="severity-filter" oninput="document.getElementById('severity-val').textContent=this.value">
        <button class="btn btn-primary w-100 mt-2" onclick="applyFilters()"><i class="fas fa-check"></i> Apply</button>
    </div>

    <h6><i class="fas fa-list"></i> Active Incidents</h6>
    <div id="incident-list" style="max-height:200px;overflow-y:auto">
        <p class="text-muted text-center">No active incidents</p>
    </div>

    <h6 class="mt-3"><i class="fas fa-people-group" style="color:#9c27b0"></i> Crowd Detections</h6>
    <div id="crowd-list" style="max-height:200px;overflow-y:auto">
        <p class="text-muted text-center">No crowd detections</p>
    </div>

    <div class="mt-3">
        <button class="btn btn-danger w-100 mb-2" onclick="openReportModal()"><i class="fas fa-plus-circle"></i> Report Emergency</button>
        <button class="btn btn-info w-100 mb-2" onclick="toggleHeatmap()"><i class="fas fa-fire"></i> Toggle Heatmap</button>
        <button class="btn btn-outline-secondary w-100" id="toggle-crowd-btn" onclick="toggleCrowdLayer()"><i class="fas fa-people-group"></i> Toggle Crowd Layer</button>
    </div>
</div>

<!-- ===== MAP ===== -->
<div class="map-container">
    <div id="map"></div>
    <button class="current-location-btn" onclick="goToCurrentLocation()" title="Go to my location">
        <i class="fas fa-location-dot"></i>
    </button>
</div>

<!-- ===== LEGEND ===== -->
<div class="legend">
    <h6 class="mb-2">Incidents</h6>
    <div class="legend-item"><div class="legend-color critical"></div><span>Critical (5)</span></div>
    <div class="legend-item"><div class="legend-color high"></div><span>High (4)</span></div>
    <div class="legend-item"><div class="legend-color medium"></div><span>Medium (3)</span></div>
    <div class="legend-item"><div class="legend-color low"></div><span>Low (1-2)</span></div>
    <hr>
    <div class="legend-item"><i class="fas fa-ambulance resource-icon ambulance"></i><span class="ms-2">Ambulance</span></div>
    <div class="legend-item"><i class="fas fa-fire-extinguisher resource-icon fire"></i><span class="ms-2">Fire Truck</span></div>
    <div class="legend-item"><i class="fas fa-car resource-icon police"></i><span class="ms-2">Police</span></div>
    <hr>
    <h6 class="mb-2" style="font-size:13px">Crowd Density</h6>
    <div class="legend-item"><div class="legend-crowd-dot" style="background:radial-gradient(circle at 35% 35%,#ff4444,#8b0000)"></div><span>Critical (&gt;500)</span></div>
    <div class="legend-item"><div class="legend-crowd-dot" style="background:radial-gradient(circle at 35% 35%,#ff8800,#cc5500)"></div><span>High (200‚Äì500)</span></div>
    <div class="legend-item"><div class="legend-crowd-dot" style="background:radial-gradient(circle at 35% 35%,#ffcc00,#cc9900)"></div><span>Moderate (50‚Äì200)</span></div>
    <div class="legend-item"><div class="legend-crowd-dot" style="background:radial-gradient(circle at 35% 35%,#44cc44,#228822)"></div><span>Low (&lt;50)</span></div>
</div>

<!-- ===== REPORT MODAL ===== -->
<div class="modal fade" id="reportModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Report Emergency</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeReportModal()"></button>
            </div>
            <div class="modal-body">
                <form id="report-form">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Emergency Type</label>
                        <select class="form-select" id="emergency-type" required>
                            <option value="">Select type...</option>
                            <option value="fire">üî• Fire</option>
                            <option value="medical">üöë Medical Emergency</option>
                            <option value="accident">üí• Accident</option>
                            <option value="flood">üåä Flood</option>
                            <option value="earthquake">üèöÔ∏è Earthquake</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-map-marker-alt text-danger me-1"></i>Select Location</label>
                        <div class="location-method-tabs">
                            <button type="button" class="loc-tab-btn active" onclick="switchLocationTab('search')" id="tab-search"><i class="fas fa-search"></i> Search Address</button>
                            <button type="button" class="loc-tab-btn" onclick="switchLocationTab('map')" id="tab-map"><i class="fas fa-map-pin"></i> Click on Map</button>
                            <button type="button" class="loc-tab-btn" onclick="switchLocationTab('gps')" id="tab-gps"><i class="fas fa-location-dot"></i> Use GPS</button>
                        </div>

                        <div class="location-panel active" id="panel-search">
                            <div class="address-search-wrapper">
                                <input type="text" class="address-search-input" id="address-search-input" placeholder="Type an address or place name..." autocomplete="off" oninput="onAddressInput(this.value)" onkeydown="onAddressKeydown(event)" />
                                <button type="button" class="address-search-btn" id="address-search-btn" onclick="triggerAddressSearch()"><i class="fas fa-search"></i></button>
                                <div class="address-suggestions" id="address-suggestions"></div>
                            </div>
                            <div class="mt-2 text-muted" style="font-size:12px"><i class="fas fa-info-circle"></i> Results powered by OpenStreetMap</div>
                        </div>

                        <div class="location-panel" id="panel-map">
                            <div class="mini-map-wrapper">
                                <div class="mini-map-header">
                                    <i class="fas fa-crosshairs"></i>
                                    <span>Click anywhere on the map to drop a pin</span>
                                    <button type="button" class="mini-map-reset-btn" onclick="resetMiniMap()"><i class="fas fa-undo"></i> Reset</button>
                                </div>
                                <div id="mini-map" class="mini-map-canvas"></div>
                                <div class="mini-map-footer" id="mini-map-footer">
                                    <i class="fas fa-map-pin text-muted"></i>
                                    <span class="text-muted" id="mini-map-hint">No pin dropped yet ‚Äî click the map above</span>
                                </div>
                            </div>
                        </div>

                        <div class="location-panel" id="panel-gps">
                            <button type="button" class="gps-panel-btn" id="gps-detect-btn" onclick="detectGPSLocation()"><i class="fas fa-location-dot"></i> Detect My Current Location</button>
                            <div class="mt-2 text-muted" style="font-size:12px;text-align:center"><i class="fas fa-lock"></i> Location is used only for this report</div>
                        </div>

                        <div class="selected-location-card" id="selected-location-card">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <div class="loc-name" id="selected-loc-name">Selected Location</div>
                                <div class="loc-coords" id="selected-loc-coords"></div>
                            </div>
                            <button type="button" class="loc-clear-btn" onclick="clearLocation()"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <input type="hidden" id="selected-lat">
                        <input type="hidden" id="selected-lng">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Severity (1-5)</label>
                        <input type="range" class="form-range" id="severity" min="1" max="5" value="3">
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-success">Low (1)</span>
                            <span class="badge bg-warning">Medium (3)</span>
                            <span class="badge bg-danger">Critical (5)</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Describe the emergency in detail..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-camera me-1 text-secondary"></i>Evidence &amp; Media
                            <span class="ms-2" id="verification-badge-inline">
                                <span class="badge-unverified"><i class="fas fa-clock"></i> Unverified</span>
                            </span>
                        </label>
                        <div class="media-upload-zone" id="media-upload-zone" onclick="document.getElementById('media-file-input').click()" ondragover="onMediaDragOver(event)" ondragleave="onMediaDragLeave(event)" ondrop="onMediaDrop(event)">
                            <i class="fas fa-cloud-upload-alt media-upload-icon"></i>
                            <div class="media-upload-title">Drop photos &amp; videos here</div>
                            <div class="media-upload-sub">or click to browse &nbsp;¬∑&nbsp; JPG, PNG, MP4, MOV</div>
                            <div class="media-btn-row">
                                <button type="button" class="media-action-btn photo-btn" onclick="event.stopPropagation();openCamera('photo')"><i class="fas fa-camera"></i> Take Photo</button>
                                <button type="button" class="media-action-btn video-btn" onclick="event.stopPropagation();openCamera('video')"><i class="fas fa-video"></i> Record Video</button>
                                <button type="button" class="media-action-btn file-btn" onclick="event.stopPropagation();document.getElementById('media-file-input').click()"><i class="fas fa-folder-open"></i> Browse Files</button>
                            </div>
                        </div>
                        <input type="file" id="media-file-input" accept="image/*,video/*" multiple style="display:none" onchange="onMediaFilesSelected(this.files)">
                        <input type="file" id="camera-photo-input" accept="image/*" capture="environment" style="display:none" onchange="onMediaFilesSelected(this.files)">
                        <input type="file" id="camera-video-input" accept="video/*" capture="environment" style="display:none" onchange="onMediaFilesSelected(this.files)">
                        <div class="media-preview-grid" id="media-preview-grid"></div>
                        <div class="verification-bar" id="verification-bar">
                            <div class="vbar-icon unverified" id="vbar-icon"><i class="fas fa-shield-halved"></i></div>
                            <div class="vbar-text">
                                <div class="vbar-title" id="vbar-title">Assessment: <strong>Unverified</strong></div>
                                <div class="vbar-sub" id="vbar-sub">Add at least one photo or video to verify this report</div>
                            </div>
                            <div class="vbar-count" id="vbar-count">0 files</div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Camera overlay (nested) -->
            <div id="camera-overlay" class="camera-overlay" style="display:none">
                <div class="camera-box">
                    <div class="camera-header">
                        <span id="camera-title"><i class="fas fa-camera"></i> Take Photo</span>
                        <button type="button" onclick="closeCamera()" class="camera-close-btn"><i class="fas fa-times"></i></button>
                    </div>
                    <video id="camera-preview" class="camera-preview" autoplay playsinline muted></video>
                    <canvas id="camera-canvas" style="display:none"></canvas>
                    <div class="camera-controls">
                        <button type="button" class="cam-ctrl-btn cam-flip" onclick="flipCamera()"><i class="fas fa-rotate"></i></button>
                        <button type="button" class="cam-ctrl-btn cam-capture" id="cam-capture-btn" onclick="captureMedia()"><span class="cam-capture-ring"></span></button>
                        <button type="button" class="cam-ctrl-btn cam-cancel" onclick="closeCamera()"><i class="fas fa-xmark"></i></button>
                    </div>
                    <div class="camera-hint" id="camera-hint">Tap the button to capture</div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="me-auto"><span id="footer-verification-badge"></span></div>
                <button type="button" class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitReport()" id="submit-btn" disabled><i class="fas fa-paper-plane"></i> Submit Report</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ==================== GLOBAL STATE ====================
let map, incidentsLayer, resourcesLayer, heatmapLayer = null;
let crowdLayer = null, crowdVisible = true, activeCrowdDetections = [];
let selectedLocation = null, locationMarker = null;
let reportModal, isReportModalOpen = false;
let activeIncidents = [], userLocation = null;
let miniMap = null, miniPinMarker = null, miniMapInitialized = false;
let searchDebounceTimer = null, currentSuggestions = [], activeSuggestionIndex = -1, searchAbortController = null;
let mediaFiles = [], cameraStream = null, cameraMode = 'photo';
let mediaRecorder = null, recordedChunks = [], isRecording = false, facingMode = 'environment';

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    if (typeof L === 'undefined') {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;flex-direction:column;gap:16px"><h2>‚ö†Ô∏è Leaflet failed to load</h2><p>Please check your internet connection and refresh the page.</p><button onclick="location.reload()" style="padding:10px 24px;background:#2a5298;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px">Reload</button></div>';
        return;
    }
    initializeMap();
    loadData();
    getUserLocation();

    const modalEl = document.getElementById('reportModal');
    reportModal = new bootstrap.Modal(modalEl);
    modalEl.addEventListener('show.bs.modal', () => { isReportModalOpen = true; });
    modalEl.addEventListener('hide.bs.modal', () => {
        isReportModalOpen = false;
        clearLocation(); closeSuggestions(); destroyMiniMap(); closeCamera(); resetMediaState();
    });
    document.addEventListener('click', e => { if (!e.target.closest('.address-search-wrapper')) closeSuggestions(); });
    setInterval(loadData, 30000);
});

// ==================== MAP INIT ====================
function initializeMap() {
    map = L.map('map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
    incidentsLayer = L.layerGroup().addTo(map);
    resourcesLayer = L.layerGroup().addTo(map);
    crowdLayer     = L.layerGroup().addTo(map);
    map.on('click', e => {
        if (isReportModalOpen) {
            reverseGeocode(e.latlng.lat, e.latlng.lng).then(addr => selectLocationForReport(e.latlng, addr || `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`));
        }
    });
}

// ==================== DATA LOADING ====================
async function loadData() {
    try {
        let incidents, resources, crowdData;

        try { const r = await fetch('http://localhost:5000/api/incidents/active'); incidents = await r.json();
            if (incidents.features) {
                if (!activeIncidents.length) { activeIncidents = incidents.features; }
                else { const ids = new Set(activeIncidents.map(i=>i.properties.id)); const news = incidents.features.filter(i=>!ids.has(i.properties.id)); activeIncidents = [...activeIncidents, ...news]; }
                incidents.features = activeIncidents;
            }
        } catch { if (!activeIncidents.length) { incidents = getMockIncidents(); activeIncidents = incidents.features; } else incidents = { features: activeIncidents }; }

        try { const r = await fetch('http://localhost:5000/api/resources/available'); resources = await r.json(); }
        catch { resources = getMockResources(); }

        try { const r = await fetch('http://localhost:5000/api/crowd/detections'); crowdData = await r.json(); }
        catch { crowdData = getMockCrowdData(); }

        renderIncidents(incidents);
        renderResources(resources);
        renderCrowdDetections(crowdData);
        updateDashboard(incidents);
    } catch { showToast('Error loading data', 'error'); }
}

// ==================== RENDER: INCIDENTS ====================
function renderIncidents(data) {
    incidentsLayer.clearLayers();
    if (!data.features?.length) return;
    data.features.forEach(f => {
        const [lng, lat] = f.geometry.coordinates;
        const p = f.properties, sev = p.severity || 3;
        const cls = sev>=5?'critical':sev>=4?'high':sev>=3?'medium':'low';
        const m = L.marker([lat,lng], { icon: L.divIcon({ html:`<div class="emergency-marker ${cls}">${sev}</div>`, className:'', iconSize:[40,40] }) });
        m.bindPopup(`<div style="min-width:200px"><h6 class="mb-2">üö® ${p.type.toUpperCase()}</h6><p><strong>Severity:</strong> ${sev}/5</p><p><strong>Location:</strong> ${p.address||'Unknown'}</p><p><strong>Reported:</strong> ${new Date(p.reported_at).toLocaleString()}</p>${p.description?`<p><strong>Details:</strong> ${p.description}</p>`:''}<p><strong>Assessment:</strong> ${p.verified?`<span style="color:#1b5e20;font-weight:700">‚úì Field Verified</span> <span style="color:#aaa;font-size:11px">(${p.media_count||0} file${(p.media_count||0)>1?'s':''})</span>`:`<span style="color:#856404;font-weight:700">‚è≥ Unverified</span>`}</p></div>`);
        m.addTo(incidentsLayer);
    });
}

// ==================== RENDER: RESOURCES ====================
function renderResources(data) {
    resourcesLayer.clearLayers();
    if (!data.features?.length) return;
    data.features.forEach(f => {
        const [lng, lat] = f.geometry.coordinates, p = f.properties;
        let icon='fa-ambulance', color='ambulance';
        if (p.type==='fire_truck'){icon='fa-fire-extinguisher';color='fire';}
        else if(p.type==='police'){icon='fa-car';color='police';}
        const m = L.marker([lat,lng], { icon: L.divIcon({ html:`<i class="fas ${icon} resource-icon ${color}"></i>`, className:'', iconSize:[30,30] }) });
        m.bindPopup(`<b>${p.type.replace('_',' ').toUpperCase()}</b><br>Status: ${p.status}`);
        m.addTo(resourcesLayer);
    });
}

// ==================== RENDER: CROWD DETECTIONS ====================
function renderCrowdDetections(data) {
    crowdLayer.clearLayers();
    if (!data.features?.length) { updateCrowdSidebar([]); return; }
    activeCrowdDetections = data.features;
    data.features.forEach(f => {
        const [lng, lat] = f.geometry.coordinates, p = f.properties;
        const count = p.crowd_count || 0;
        const density = p.density || getCrowdDensityClass(count);
        const isAnom = p.anomaly || false;
        const size = count>=500?44:count>=200?38:count>=50?32:26;
        const warningHtml = isAnom?`<span class="crowd-warning"><i class="fas fa-exclamation" style="font-size:8px"></i></span>`:'';
        const markerHtml = `<div class="crowd-marker crowd-${density}" style="width:${size}px;height:${size}px;"><i class="fas fa-people-group" style="font-size:${Math.round(size*0.38)}px"></i>${warningHtml}</div>`;
        const m = L.marker([lat,lng], { icon: L.divIcon({ html:markerHtml, className:'', iconSize:[size+12,size+12], iconAnchor:[(size+12)/2,(size+12)/2] }), zIndexOffset:500 });
        const dlabels={critical:'üî¥ Critical',high:'üü† High',moderate:'üü° Moderate',low:'üü¢ Low'};
        const anomRow = isAnom?`<p><strong>‚ö†Ô∏è Anomaly:</strong> <span style="color:#cc0000;font-weight:700">Unusual behavior detected</span></p>`:'';
        m.bindPopup(`<div style="min-width:210px"><h6 class="mb-2">üë• Crowd Detection</h6><p><strong>Location:</strong> ${p.location||'Unknown'}</p><p><strong>Crowd Count:</strong> ~${count.toLocaleString()} people</p><p><strong>Density:</strong> ${dlabels[density]||density}</p>${anomRow}<p><strong>Detected:</strong> ${new Date(p.detected_at).toLocaleString()}</p><p style="font-size:11px;color:#888;margin-top:6px"><i class="fas fa-camera"></i> Source: ${p.source||'CCTV Network'}</p></div>`);
        m.addTo(crowdLayer);
    });
    updateCrowdSidebar(data.features);
    document.getElementById('active-crowd-count').textContent = data.features.length;
}

function getCrowdDensityClass(count) {
    return count>=500?'critical':count>=200?'high':count>=50?'moderate':'low';
}

function updateCrowdSidebar(features) {
    const el = document.getElementById('crowd-list');
    document.getElementById('active-crowd-count').textContent = features.length;
    if (!features.length) { el.innerHTML='<p class="text-muted text-center">No crowd detections</p>'; return; }
    const sorted = [...features].sort((a,b)=>(b.properties.crowd_count||0)-(a.properties.crowd_count||0));
    el.innerHTML = sorted.map(f => {
        const [lng,lat]=f.geometry.coordinates, p=f.properties;
        const count=p.crowd_count||0, density=p.density||getCrowdDensityClass(count);
        const pillCls={critical:'pill-critical',high:'pill-high',moderate:'pill-moderate',low:'pill-low'}[density]||'pill-low';
        const anomIcon=p.anomaly?` <i class="fas fa-exclamation-triangle text-danger" style="font-size:10px" title="Anomaly"></i>`:'';
        return `<div class="crowd-item crowd-${density}" onclick="map.setView([${lat},${lng}],16)">
            <strong>üë• ~${count.toLocaleString()} people${anomIcon}</strong>
            <span class="crowd-density-pill ${pillCls}">${density.charAt(0).toUpperCase()+density.slice(1)}</span>
            <small class="d-block text-muted mt-1">${p.location||'Unknown location'}</small>
            <small class="text-muted">${new Date(p.detected_at).toLocaleTimeString()}</small>
        </div>`;
    }).join('');
}

// ==================== TOGGLE CROWD LAYER ====================
function toggleCrowdLayer() {
    crowdVisible = !crowdVisible;
    const btn = document.getElementById('toggle-crowd-btn');
    if (crowdVisible) {
        map.addLayer(crowdLayer);
        btn.className = 'btn btn-outline-secondary w-100';
        btn.innerHTML = '<i class="fas fa-people-group"></i> Toggle Crowd Layer';
        showToast('Crowd layer enabled', 'info');
    } else {
        map.removeLayer(crowdLayer);
        btn.className = 'btn btn-secondary w-100';
        btn.innerHTML = '<i class="fas fa-people-group"></i> Crowd Layer (Hidden)';
        showToast('Crowd layer hidden', 'info');
    }
}

// ==================== DASHBOARD ====================
function updateDashboard(incidents) {
    document.getElementById('active-incidents').textContent = incidents.features?.length || 0;
    document.getElementById('available-resources').textContent = 3;
    const el = document.getElementById('incident-list');
    if (!incidents.features?.length) { el.innerHTML='<p class="text-muted text-center">No active incidents</p>'; return; }
    el.innerHTML = incidents.features.map(f => {
        const p=f.properties, [lng,lat]=f.geometry.coordinates, sev=p.severity||3;
        const cls=sev>=5?'critical':sev>=4?'high':sev>=3?'medium':'low';
        return `<div class="incident-item ${cls}" onclick="map.setView([${lat},${lng}],15)"><strong>${p.type.toUpperCase()}</strong><small class="d-block text-muted">${p.address||'Unknown'}</small><small>Severity: ${sev}/5</small></div>`;
    }).join('');
}

// ==================== HEATMAP ====================
function toggleHeatmap() {
    if (heatmapLayer) { map.removeLayer(heatmapLayer); heatmapLayer=null; showToast('Heatmap disabled','info'); return; }
    const pts=[];
    incidentsLayer.eachLayer(l => { const ll=l.getLatLng(); pts.push([ll.lat,ll.lng,1]); });
    if (pts.length) { heatmapLayer=L.heatLayer(pts,{radius:25,blur:15,gradient:{0.2:'#00ff00',0.4:'#ffff00',0.6:'#ff9900',0.8:'#ff0000'}}).addTo(map); showToast('Heatmap enabled','success'); }
    else showToast('No data for heatmap','warning');
}

// ==================== LOCATION TAB ====================
function switchLocationTab(tab) {
    document.querySelectorAll('.loc-tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    document.querySelectorAll('.location-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-'+tab).classList.add('active');
    if (tab==='map') setTimeout(()=>initMiniMap(),80); else destroyMiniMap();
}

// ==================== MINI MAP ====================
function initMiniMap() {
    if (miniMap) { miniMap.invalidateSize(); return; }
    const center = userLocation?[userLocation.lat,userLocation.lng]:[28.6139,77.2090];
    miniMap = L.map('mini-map',{center,zoom:13,zoomControl:true,attributionControl:false});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(miniMap);
    if (selectedLocation) { dropMiniPin(selectedLocation.lat,selectedLocation.lng,false); miniMap.setView([selectedLocation.lat,selectedLocation.lng],15); }
    miniMap.on('click',e=>dropMiniPin(e.latlng.lat,e.latlng.lng,true));
    miniMapInitialized=true;
}

function dropMiniPin(lat,lng,animate) {
    if (miniPinMarker) miniMap.removeLayer(miniPinMarker);
    const pinHtml=`<div class="mini-pin-marker" style="${animate?'':'animation:none'}"><div class="mini-pin-head"></div><div class="mini-pin-shadow"></div></div>`;
    miniPinMarker=L.marker([lat,lng],{icon:L.divIcon({html:pinHtml,className:'',iconSize:[22,30],iconAnchor:[11,28]}),zIndexOffset:1000}).addTo(miniMap);
    const footer=document.getElementById('mini-map-footer'), hint=document.getElementById('mini-map-hint');
    footer.classList.add('pinned');
    hint.innerHTML=`<i class="fas fa-check-circle" style="color:#28a745"></i>&nbsp; Pin at ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    document.querySelector('.mini-map-wrapper').classList.add('has-pin');
    reverseGeocode(lat,lng).then(addr=>{
        const name=addr||`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        hint.textContent=`üìç ${name.split(',').slice(0,3).join(', ')}`;
        selectLocationForReport({lat,lng},name);
    });
    miniMap.panTo([lat,lng],{animate:true,duration:0.4});
}

function resetMiniMap() {
    if (miniPinMarker){miniMap.removeLayer(miniPinMarker);miniPinMarker=null;}
    document.getElementById('mini-map-footer').classList.remove('pinned');
    document.getElementById('mini-map-hint').textContent='No pin dropped yet ‚Äî click the map above';
    document.querySelector('.mini-map-wrapper').classList.remove('has-pin');
    clearLocation();
}

function destroyMiniMap() {
    if (miniMap){miniMap.remove();miniMap=null;miniPinMarker=null;miniMapInitialized=false;}
}

// ==================== ADDRESS SEARCH ====================
function onAddressInput(value) {
    clearTimeout(searchDebounceTimer); activeSuggestionIndex=-1;
    if (value.length<3){closeSuggestions();return;}
    searchDebounceTimer=setTimeout(()=>searchAddress(value),400);
}

function onAddressKeydown(e) {
    const items=document.getElementById('address-suggestions').querySelectorAll('.suggestion-item');
    if (e.key==='ArrowDown'){e.preventDefault();activeSuggestionIndex=Math.min(activeSuggestionIndex+1,items.length-1);highlightSuggestion(items);}
    else if(e.key==='ArrowUp'){e.preventDefault();activeSuggestionIndex=Math.max(activeSuggestionIndex-1,-1);highlightSuggestion(items);}
    else if(e.key==='Enter'){e.preventDefault();activeSuggestionIndex>=0&&items[activeSuggestionIndex]?items[activeSuggestionIndex].click():triggerAddressSearch();}
    else if(e.key==='Escape') closeSuggestions();
}

function highlightSuggestion(items) {
    items.forEach((item,i)=>item.style.background=i===activeSuggestionIndex?'#e8eef8':'');
    if(activeSuggestionIndex>=0&&items[activeSuggestionIndex]) items[activeSuggestionIndex].scrollIntoView({block:'nearest'});
}

function triggerAddressSearch(){const q=document.getElementById('address-search-input').value.trim();if(q.length>=3)searchAddress(q);}

async function searchAddress(query) {
    if(searchAbortController) searchAbortController.abort();
    searchAbortController=new AbortController();
    const btn=document.getElementById('address-search-btn');
    btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
    try {
        const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=6&addressdetails=1`,{signal:searchAbortController.signal,headers:{'Accept':'application/json'}});
        if(!r.ok) throw new Error();
        displaySuggestions(await r.json());
    } catch(err){if(err.name!=='AbortError') showSuggestionsError('Search failed. Check your connection.');}
    finally{btn.innerHTML='<i class="fas fa-search"></i>';}
}

function displaySuggestions(results) {
    const c=document.getElementById('address-suggestions'); activeSuggestionIndex=-1;
    if(!results?.length){c.innerHTML=`<div class="suggestion-no-results"><i class="fas fa-search me-2"></i>No results found.</div>`;c.classList.add('visible');return;}
    currentSuggestions=results;
    c.innerHTML=results.map((r,i)=>{const addr=r.address||{};const main=r.name||addr.road||addr.neighbourhood||r.display_name.split(',')[0];return`<div class="suggestion-item" onclick="selectSuggestion(${i})"><i class="fas fa-map-marker-alt"></i><div><div class="sug-main">${escapeHtml(main)}</div><div class="sug-sub">${escapeHtml(r.display_name)}</div></div></div>`;}).join('');
    c.classList.add('visible');
}

function showSuggestionsError(msg){const c=document.getElementById('address-suggestions');c.innerHTML=`<div class="suggestion-no-results text-danger"><i class="fas fa-exclamation-circle me-2"></i>${msg}</div>`;c.classList.add('visible');}

function selectSuggestion(i) {
    const r=currentSuggestions[i]; if(!r) return;
    const lat=parseFloat(r.lat),lng=parseFloat(r.lon);
    document.getElementById('address-search-input').value=r.display_name.split(',').slice(0,2).join(',');
    closeSuggestions();
    selectLocationForReport({lat,lng},r.display_name);
    map.flyTo([lat,lng],16,{animate:true,duration:1.2});
}

function closeSuggestions(){document.getElementById('address-suggestions').classList.remove('visible');activeSuggestionIndex=-1;}

function escapeHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ==================== GPS ====================
function detectGPSLocation() {
    const btn=document.getElementById('gps-detect-btn');
    btn.classList.add('loading');btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Detecting...';
    if(!navigator.geolocation){showToast('Geolocation not supported','warning');resetGPSButton();return;}
    navigator.geolocation.getCurrentPosition(
        pos=>{const{latitude:lat,longitude:lng}=pos.coords;userLocation={lat,lng};reverseGeocode(lat,lng).then(addr=>{selectLocationForReport({lat,lng},addr||`${lat.toFixed(5)}, ${lng.toFixed(5)}`);map.flyTo([lat,lng],16,{animate:true,duration:1.2});resetGPSButton();});},
        ()=>{showToast('Could not get GPS location.','warning');resetGPSButton();},
        {timeout:10000,maximumAge:60000}
    );
}

function resetGPSButton(){const btn=document.getElementById('gps-detect-btn');btn.classList.remove('loading');btn.innerHTML='<i class="fas fa-location-dot"></i> Detect My Current Location';}

async function reverseGeocode(lat,lng){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,{headers:{'Accept':'application/json'}});const d=await r.json();return d.display_name||null;}catch{return null;}}

// ==================== USER LOCATION ====================
function getUserLocation() {
    if(!navigator.geolocation){userLocation={lat:28.6139,lng:77.2090};return;}
    navigator.geolocation.getCurrentPosition(
        pos=>{userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};L.circleMarker([userLocation.lat,userLocation.lng],{radius:8,color:'#28a745',fillColor:'#28a745',fillOpacity:0.5,weight:2}).addTo(map).bindPopup('Your location');map.setView([userLocation.lat,userLocation.lng],14);showToast('Location detected!','success');},
        ()=>{userLocation={lat:28.6139,lng:77.2090};map.setView([userLocation.lat,userLocation.lng],12);}
    );
}

function goToCurrentLocation() {
    if(userLocation){map.setView([userLocation.lat,userLocation.lng],16);const m=L.circleMarker([userLocation.lat,userLocation.lng],{radius:12,color:'#28a745',fillColor:'#28a745',fillOpacity:0.8,weight:3}).addTo(map).bindPopup('You are here').openPopup();setTimeout(()=>map.removeLayer(m),3000);}
    else getUserLocation();
}

// ==================== LOCATION SELECTION ====================
function selectLocationForReport(latlng,displayName) {
    selectedLocation=latlng;
    if(locationMarker) map.removeLayer(locationMarker);
    locationMarker=L.circleMarker([latlng.lat,latlng.lng],{radius:12,color:'#007bff',fillColor:'#007bff',fillOpacity:0.8,weight:3}).addTo(map);
    document.getElementById('selected-lat').value=latlng.lat.toFixed(6);
    document.getElementById('selected-lng').value=latlng.lng.toFixed(6);
    const name=displayName||'Selected Location';
    document.getElementById('selected-loc-name').textContent=name.length>60?name.substring(0,60)+'...':name;
    document.getElementById('selected-loc-coords').textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    document.getElementById('selected-location-card').classList.add('visible');
    document.getElementById('submit-btn').disabled=false;
}

function clearLocation() {
    selectedLocation=null;
    if(locationMarker){map.removeLayer(locationMarker);locationMarker=null;}
    document.getElementById('selected-lat').value='';
    document.getElementById('selected-lng').value='';
    document.getElementById('selected-location-card').classList.remove('visible');
    document.getElementById('submit-btn').disabled=true;
    document.getElementById('address-search-input').value='';
    closeSuggestions();
}

// ==================== MODAL ====================
function openReportModal(){clearLocation();resetMediaState();reportModal.show();switchLocationTab('search');}
function closeReportModal(){reportModal.hide();}

// ==================== SUBMIT ====================
function submitReport() {
    if(!selectedLocation){showToast('Please select a location','warning');return;}
    const type=document.getElementById('emergency-type').value;
    if(!type){showToast('Please select emergency type','warning');return;}
    const sev=document.getElementById('severity').value;
    const desc=document.getElementById('description').value;
    const locName=document.getElementById('selected-loc-name').textContent;
    const activeMedia=mediaFiles.filter(Boolean);
    const isVerified=activeMedia.length>0;
    activeIncidents.push({type:'Feature',geometry:{type:'Point',coordinates:[selectedLocation.lng,selectedLocation.lat]},properties:{id:activeIncidents.length+1,type,severity:parseInt(sev),address:locName!=='Selected Location'?locName:`${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}`,reported_at:new Date().toISOString(),status:'active',description:desc,verified:isVerified,media_count:activeMedia.length,photo_count:activeMedia.filter(f=>f.type==='photo').length,video_count:activeMedia.filter(f=>f.type==='video').length}});
    const incidentsData={features:activeIncidents};
    renderIncidents(incidentsData);
    updateDashboard(incidentsData);
    showToast(`Emergency reported! ${isVerified?`‚úì Verified with ${activeMedia.length} file(s)`:'Submitted as unverified'}`,isVerified?'success':'warning');
    closeReportModal();
    document.getElementById('report-form').reset();
}

function applyFilters(){showToast('Filters applied','info');}
function refreshData(){loadData();showToast('Data refreshed','success');}

// ==================== MOCK DATA ====================
function getMockIncidents(){return{features:[{geometry:{coordinates:[77.2090,28.6139]},properties:{id:1,type:'fire',severity:5,address:'Connaught Place, Delhi',reported_at:new Date().toISOString()}},{geometry:{coordinates:[77.2190,28.6239]},properties:{id:2,type:'medical',severity:4,address:'Preet Vihar, Delhi',reported_at:new Date().toISOString()}},{geometry:{coordinates:[77.2290,28.6099]},properties:{id:3,type:'accident',severity:3,address:'Saket, Delhi',reported_at:new Date().toISOString()}}]};}
function getMockResources(){return{features:[{geometry:{coordinates:[77.1990,28.6039]},properties:{id:1,type:'ambulance',status:'available'}},{geometry:{coordinates:[77.2290,28.6339]},properties:{id:2,type:'fire_truck',status:'available'}},{geometry:{coordinates:[77.1890,28.5939]},properties:{id:3,type:'police',status:'available'}}]};}
function getMockCrowdData(){const now=new Date().toISOString();return{features:[{geometry:{coordinates:[77.2090,28.6339]},properties:{id:'c1',crowd_count:620,density:'critical',location:'India Gate, Delhi',detected_at:now,anomaly:true,source:'CCTV Cam #14'}},{geometry:{coordinates:[77.2390,28.6039]},properties:{id:'c2',crowd_count:285,density:'high',location:'Lajpat Nagar Market, Delhi',detected_at:now,anomaly:false,source:'CCTV Cam #7'}},{geometry:{coordinates:[77.1790,28.6239]},properties:{id:'c3',crowd_count:340,density:'high',location:'Karol Bagh, Delhi',detected_at:now,anomaly:true,source:'CCTV Cam #22'}},{geometry:{coordinates:[77.2490,28.6539]},properties:{id:'c4',crowd_count:95,density:'moderate',location:'Paharganj, Delhi',detected_at:now,anomaly:false,source:'CCTV Cam #3'}},{geometry:{coordinates:[77.1690,28.5939]},properties:{id:'c5',crowd_count:30,density:'low',location:'Vasant Kunj, Delhi',detected_at:now,anomaly:false,source:'CCTV Cam #31'}}]};}

// ==================== TOAST ====================
function showToast(message,type='info'){const bg={success:'success',warning:'warning',error:'danger',info:'info'};const t=document.createElement('div');t.className=`toast align-items-center text-white bg-${bg[type]||'info'} border-0`;t.innerHTML=`<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;let c=document.querySelector('.toast-container');if(!c){c=document.createElement('div');c.className='toast-container';document.body.appendChild(c);}c.appendChild(t);setTimeout(()=>t.remove(),3500);}

// ==================== MEDIA ====================
function onMediaDragOver(e){e.preventDefault();document.getElementById('media-upload-zone').classList.add('dragover');}
function onMediaDragLeave(){document.getElementById('media-upload-zone').classList.remove('dragover');}
function onMediaDrop(e){e.preventDefault();document.getElementById('media-upload-zone').classList.remove('dragover');addMediaFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')||f.type.startsWith('video/')));}
function onMediaFilesSelected(fl){addMediaFiles(Array.from(fl).filter(f=>f.type.startsWith('image/')||f.type.startsWith('video/')));document.getElementById('media-file-input').value='';document.getElementById('camera-photo-input').value='';document.getElementById('camera-video-input').value='';}
function addMediaFiles(files){files.forEach(file=>{const url=URL.createObjectURL(file),type=file.type.startsWith('video/')?'video':'photo';mediaFiles.push({file,url,type});addThumbToGrid(mediaFiles.length-1,url,type);});updateVerificationStatus();}
function addThumbToGrid(index,url,type){const grid=document.getElementById('media-preview-grid'),thumb=document.createElement('div');thumb.className='preview-thumb';thumb.id=`thumb-${index}`;if(type==='video'){thumb.innerHTML=`<video src="${url}" muted playsinline preload="metadata"></video><span class="thumb-type-badge"><i class="fas fa-video"></i> VID</span><button class="thumb-remove" onclick="removeMedia(${index})"><i class="fas fa-times"></i></button>`;}else{thumb.innerHTML=`<img src="${url}" alt="Evidence"><span class="thumb-type-badge"><i class="fas fa-image"></i> IMG</span><button class="thumb-remove" onclick="removeMedia(${index})"><i class="fas fa-times"></i></button>`;}grid.appendChild(thumb);}
function removeMedia(index){URL.revokeObjectURL(mediaFiles[index].url);mediaFiles[index]=null;const t=document.getElementById(`thumb-${index}`);if(t){t.style.cssText='transform:scale(0);opacity:0;transition:all 0.2s';setTimeout(()=>t.remove(),200);}updateVerificationStatus();}

function updateVerificationStatus(){
    const active=mediaFiles.filter(Boolean),count=active.length,isV=count>0;
    document.getElementById('media-upload-zone').classList.toggle('has-files',isV);
    document.getElementById('verification-badge-inline').innerHTML=isV?`<span class="badge-verified"><i class="fas fa-shield-halved"></i> Verified</span>`:`<span class="badge-unverified"><i class="fas fa-clock"></i> Unverified</span>`;
    const bar=document.getElementById('verification-bar'),icon=document.getElementById('vbar-icon'),title=document.getElementById('vbar-title'),sub=document.getElementById('vbar-sub'),cnt=document.getElementById('vbar-count');
    bar.classList.toggle('verified',isV);icon.classList.toggle('unverified',!isV);icon.classList.toggle('verified',isV);
    if(isV){const photos=active.filter(f=>f.type==='photo').length,videos=active.filter(f=>f.type==='video').length,parts=[];if(photos)parts.push(`${photos} photo${photos>1?'s':''}`);if(videos)parts.push(`${videos} video${videos>1?'s':''}`);title.innerHTML=`Assessment: <strong style="color:#1b5e20">‚úì Verified</strong>`;sub.textContent=`Includes ${parts.join(' & ')} ‚Äî report marked as field-verified`;cnt.textContent=`${count} file${count>1?'s':''}`;}
    else{title.innerHTML=`Assessment: <strong>Unverified</strong>`;sub.textContent=`Add at least one photo or video to verify this report`;cnt.textContent=`0 files`;}
    document.getElementById('footer-verification-badge').innerHTML=isV?`<span class="footer-badge-verified"><i class="fas fa-shield-halved"></i> Field Verified (${count} file${count>1?'s':''})</span>`:`<span class="footer-badge-unverified"><i class="fas fa-clock"></i> Unverified ‚Äî no media attached</span>`;
}

function resetMediaState(){mediaFiles.forEach(f=>{if(f)URL.revokeObjectURL(f.url);});mediaFiles=[];document.getElementById('media-preview-grid').innerHTML='';document.getElementById('media-upload-zone').classList.remove('has-files');updateVerificationStatus();}

// ==================== CAMERA ====================
function openCamera(mode){
    if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){document.getElementById(mode==='photo'?'camera-photo-input':'camera-video-input').click();return;}
    cameraMode=mode;isRecording=false;recordedChunks=[];facingMode='environment';
    document.getElementById('camera-title').innerHTML=mode==='photo'?'<i class="fas fa-camera"></i> Take Photo':'<i class="fas fa-video"></i> Record Video';
    document.getElementById('camera-hint').textContent=mode==='photo'?'Tap the button to capture':'Tap to start recording';
    document.getElementById('cam-capture-btn').classList.remove('recording');
    document.getElementById('camera-overlay').style.display='flex';
    startCameraStream();
}

async function startCameraStream(){try{if(cameraStream)cameraStream.getTracks().forEach(t=>t.stop());cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:cameraMode==='video'});document.getElementById('camera-preview').srcObject=cameraStream;}catch(err){showToast('Cannot access camera: '+err.message,'warning');closeCamera();}}

function flipCamera(){facingMode=facingMode==='environment'?'user':'environment';startCameraStream();}
function captureMedia(){cameraMode==='photo'?capturePhoto():toggleVideoRecord();}

function capturePhoto(){const video=document.getElementById('camera-preview'),canvas=document.getElementById('camera-canvas');canvas.width=video.videoWidth;canvas.height=video.videoHeight;canvas.getContext('2d').drawImage(video,0,0);canvas.toBlob(blob=>{addMediaFiles([new File([blob],`photo_${Date.now()}.jpg`,{type:'image/jpeg'})]);showToast('Photo captured!','success');closeCamera();},'image/jpeg',0.92);}

function toggleVideoRecord(){const btn=document.getElementById('cam-capture-btn'),hint=document.getElementById('camera-hint');if(!isRecording){recordedChunks=[];try{mediaRecorder=new MediaRecorder(cameraStream,{mimeType:'video/webm;codecs=vp9'});}catch{mediaRecorder=new MediaRecorder(cameraStream);}mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};mediaRecorder.onstop=saveRecordedVideo;mediaRecorder.start(100);isRecording=true;btn.classList.add('recording');hint.innerHTML=`<span class="rec-dot"></span> Recording... Tap to stop`;}else{mediaRecorder.stop();isRecording=false;btn.classList.remove('recording');hint.textContent='Saving...';}}

function saveRecordedVideo(){const blob=new Blob(recordedChunks,{type:'video/webm'});addMediaFiles([new File([blob],`video_${Date.now()}.webm`,{type:'video/webm'})]);showToast('Video saved!','success');closeCamera();}

function closeCamera(){if(isRecording&&mediaRecorder?.state!=='inactive'){mediaRecorder.stop();isRecording=false;}if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());cameraStream=null;}document.getElementById('camera-overlay').style.display='none';document.getElementById('camera-preview').srcObject=null;}
</script>
</body>
</html>
